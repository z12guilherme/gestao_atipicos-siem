# logstash/pipeline/vercel.conf
input {
  http {
    host => "0.0.0.0"
    port => 8080
    user => "${VERCEL_USER}"
    password => "${VERCEL_PASSWORD}"
    codec => "json_lines"
  }
}

filter {
  # Adiciona geolocalização baseada no IP do cliente
  geoip {
    source => "[proxy][clientIp]"
    target => "geoip"
    # O campo [proxy][clientIp] vem da estrutura de log da Vercel
  }
  # Converte o timestamp da Vercel para o formato correto
  date {
    match => [ "timestamp", "UNIX_MS" ]
  }
  # Verifica se o IP do cliente está na nossa lista de ameaças
  translate {
    field => "[proxy][clientIp]"
    destination => "[threat][match]"
    dictionary_path => "/usr/share/logstash/pipeline/blocklist.csv"
    fallback => "false"
    # Se houver uma correspondência, o campo [threat][match] conterá a descrição (ex: "Known Attacker")
  }
}

output {
  # Envia para o Elasticsearch que está rodando no mesmo Docker Compose
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    index => "gestao_atipicos_logs-%{+YYYY.MM.dd}"
  }
  # Adiciona uma saída para o console para fins de depuração
  stdout {
    codec => rubydebug
  }
}